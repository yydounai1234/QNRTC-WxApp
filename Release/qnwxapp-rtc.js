module.exports=function(e){var t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(n,s,function(t){return e[t]}.bind(null,s));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=15)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNPublishStatus=t.QNConnectionDisconnectedReason=t.QNConnectionState=t.QNLogLevel=t.QNRenderMode=t.QNMediaType=void 0,function(e){e.audio="audio",e.video="video"}(t.QNMediaType||(t.QNMediaType={})),function(e){e.FILL="scaleToFit",e.ASPECT_FILL="aspectFill",e.ASPECT_FIT="aspectFit"}(t.QNRenderMode||(t.QNRenderMode={})),function(e){e.VERBOSE="VERBOSE",e.INFO="INFO",e.WARNING="WARNING",e.ERROR="ERROR",e.NONE="NONE"}(t.QNLogLevel||(t.QNLogLevel={})),function(e){e.DISCONNECTED="DISCONNECTED",e.CONNECTING="CONNECTING",e.CONNECTED="CONNECTED",e.RECONNECTING="RECONNECTING",e.RECONNECTED="RECONNECTED"}(t.QNConnectionState||(t.QNConnectionState={})),function(e){e.LEAVE="LEAVE",e.KICKED_OUT="KICKED_OUT",e.ERROR="ERROR"}(t.QNConnectionDisconnectedReason||(t.QNConnectionDisconnectedReason={})),function(e){e.READY="READY",e.COMPLETED="COMPLETED",e.ERROR="ERROR"}(t.QNPublishStatus||(t.QNPublishStatus={}))},function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(s,o){function i(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}c((n=n.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Qos=t.QosEventType=t.EVENT_CATEGORY=t.EVENT_GRADE=void 0;const o=s(r(17)),i=s(r(18)),a=s(r(19)),c=r(11),u=r(20),d=r(4),l=r(5),h=r(3);var f;!function(e){e.SERVERE="servere",e.GENERAL="general",e.NORMAL="normal"}(t.EVENT_GRADE||(t.EVENT_GRADE={})),function(e){e.CORE="core"}(t.EVENT_CATEGORY||(t.EVENT_CATEGORY={})),function(e){e[e.Init=1]="Init",e[e.UnInit=2]="UnInit",e[e.JoinRoom=3]="JoinRoom",e[e.MCSAuth=4]="MCSAuth",e[e.SignalAuth=5]="SignalAuth",e[e.LeaveRoom=6]="LeaveRoom",e[e.PublisherPC=7]="PublisherPC",e[e.PublishTracks=8]="PublishTracks",e[e.UnPublishTracks=9]="UnPublishTracks",e[e.SubscriberPC=10]="SubscriberPC",e[e.SubscribeTracks=11]="SubscribeTracks",e[e.UnSubscribeTracks=13]="UnSubscribeTracks",e[e.MuteTracks=14]="MuteTracks",e[e.ICEConnectionState=15]="ICEConnectionState",e[e.CallbackStatistics=16]="CallbackStatistics",e[e.KickoutUser=17]="KickoutUser",e[e.RoomStateChanged=18]="RoomStateChanged",e[e.AudioDeviceInOut=19]="AudioDeviceInOut",e[e.VideoDeviceInOut=20]="VideoDeviceInOut",e[e.SDKError=21]="SDKError",e[e.ApplicationState=22]="ApplicationState",e[e.CreateMergeJob=24]="CreateMergeJob",e[e.UpdateMergeTracks=25]="UpdateMergeTracks",e[e.StopMerge=26]="StopMerge",e[e.DeviceChanged=28]="DeviceChanged",e[e.DefaultSetting=29]="DefaultSetting",e[e.MediaStatistics=30]="MediaStatistics",e[e.AbnormalDisconnect=31]="AbnormalDisconnect",e[e.WechatPlayerStatus=32]="WechatPlayerStatus",e[e.WechatPlayerStatistics=33]="WechatPlayerStatistics",e[e.WechatPusherStatus=34]="WechatPusherStatus",e[e.WechatPusherStatistics=35]="WechatPusherStatistics",e[e.CreateForwardJob=36]="CreateForwardJob",e[e.StopForwardJob=37]="StopForwardJob",e[e.WebsocketConnect=40]="WebsocketConnect"}(f=t.QosEventType||(t.QosEventType={}));class g{constructor(){this.events=[],this.sessionId="",this.rpcId="";const e=wx.getSystemInfoSync();h.logger.log("SystemInfo",e),this.base={qos_version:l.QOS_VERSION,app_version:e.version,sdk_version:l.VERSION,device_model:e.model,os_platform:l.OS_PLATFORM,os_version:e.system,host_environment:e.platform,app_sdkVersion:e.SDKVersion},this.lastSubmitTime=Date.now(),this.recoverStoredEvents()}getDeviceId(){return new Promise(e=>{window&&window.requestIdleCallback?window.requestIdleCallback(()=>{o.default.get(t=>{const r=(0,i.default)(JSON.stringify(t));e(r)})}):setTimeout(()=>{o.default.get(t=>{const r=(0,i.default)(JSON.stringify(t));e(r)})},500)})}setSessionId(e){for(let t=this.events.length-1;t>=0;--t){const r=this.events[t];r.session_id||(r.session_id=e)}this.sessionId=e}setRpcId(e){this.rpcId=e}setUserBase(e,t,r){this.userBase={user_id:e,room_name:t,app_id:r};for(let e=this.events.length-1;e>=0;--e){const t=this.events[e];t.user_base||(t.user_base=this.userBase)}}addEvent(e,t,r=!1){const n=Object.assign({timestamp:Date.now(),event_id:e,event_name:f[e]},t);this.events.push({user_base:this.userBase,event:n,session_id:this.sessionId,rpc_id:this.rpcId}),this.submit(r)}recoverStoredEvents(){let e="";try{e=wx.getStorageSync(l.QNRTC_EVENTS_STORATE_KEY)}catch(e){h.logger.warning("StorageGet",e)}try{wx.removeStorageSync(l.QNRTC_EVENTS_STORATE_KEY)}catch(e){h.logger.warning("StoragRemove",e)}if(!e)return;let t=JSON.parse(decodeURIComponent((0,c.atob)(e)));t=(t||[]).filter(e=>!!e.session_id&&!!e.user_base).sort((e,t)=>e.event.timestamp-t.event.timestamp)}saveEvents(){const e=(0,c.btoa)(encodeURIComponent(JSON.stringify(this.events)));try{wx.setStorageSync(l.QNRTC_EVENTS_STORATE_KEY,e)}catch(e){h.logger.warning("StorageSave",e)}}submit(e=!1){if(e||this.submitCheck())try{const e=this.encodeQosSubmitData().map(e=>n(this,void 0,void 0,(function*(){const t=this.events.filter(t=>t.session_id===e.session_id&&JSON.stringify(t.user_base)===e.base);return this.events=this.events.filter(t=>t.session_id!==e.session_id||JSON.stringify(t.user_base)!==e.base),(0,d.request)("https://pili-rtc-qos.qiniuapi.com/v1/rtcevent",{method:"POST",header:{"Content-Type":"application/x-gzip"},data:e.data.buffer}).then(()=>{this.lastSubmitTime=Date.now(),this.saveEvents()}).catch(()=>{this.events.push(...t)})})));Promise.all(e).catch(d.noop)}catch(e){h.logger.warning("EventSubmit",e)}else this.saveEvents()}submitCheck(){return!(!this.sessionId||!this.userBase)&&(Date.now()-this.lastSubmitTime>3e5||this.events.length>=30)}encodeQosSubmitData(){const e=(0,u.groupBy)(this.events,e=>e.session_id||""+JSON.stringify(e.user_base)),t=[];return Object.values(e).forEach(e=>{if(e.length>0){const r={session_id:e[0].session_id,user_base:e[0].user_base,base:this.base,items:e.map(e=>e.event)};h.logger.log("EventEncode",r);const n=new Uint8Array(a.default.zip((0,d.toUTF8Array)(JSON.stringify(r))));t.push({data:n,session_id:e[0].session_id,base:JSON.stringify(e[0].user_base)})}}),t}init(){this.userBase=void 0,this.sessionId="",this.rpcId=""}}t.Qos=g,t.default=new g},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,s)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ERROR_INVALID_PARAMETER=t.JOIN_ROOM_ERROR=t.SERVER_ERROR=t.ERROR_FATAL=t.ERROR_NETWORK_TIMEOUT=t.ERROR_RECONNECT_FAILED=t.ERROR_INVALID_STATE=t.ERROR_AUTH_FAILED=t.QNRTCError=void 0;const i=o(r(1));class a extends Error{constructor(e,t){super(t),this.code=e,this.error=t,i.default.addEvent(i.QosEventType.SDKError,{error_code:e,error_msg:t})}}t.QNRTCError=a;t.ERROR_AUTH_FAILED=e=>{new a(21001,"error connect websocket "+e)};t.ERROR_INVALID_STATE=()=>new a(21002,"error invalid state");t.ERROR_RECONNECT_FAILED=()=>new a(21003,"websocket reconnectTimes run out, reconnect stops");t.ERROR_NETWORK_TIMEOUT=()=>new a(21004,"error network timeout");t.ERROR_FATAL=e=>new a(21005,"unexpected error "+e);t.SERVER_ERROR=(e,t)=>new a(e,t);t.JOIN_ROOM_ERROR=(e,t)=>new a(e,t);t.ERROR_INVALID_PARAMETER=e=>new a(10053,e)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0;const n=r(0);t.logger=new class{constructor(e){this.level=e,this.level=e}padingStart(e){const t=e.toString();return t.length<2?"0"+t:t}getLogTimeString(){const e=new Date;return`[${this.padingStart(e.getHours())}:${this.padingStart(e.getMinutes())}:${this.padingStart(e.getSeconds())}.${e.getMilliseconds()}]`}setLevel(e){this.level=this.checkValidate(e)}log(...e){if(this.level!==n.QNLogLevel.VERBOSE)return;const t=this.getLogTimeString()+" %cLOG-QNRTC";console.info(t,"color: #66ccff; font-weight: bold;",...e)}error(...e){const t=this.getLogTimeString()+" %cERROR-QNRTC";console.info(t,"color: #fc5531; font-weight: bold;",...e)}debug(...e){if(this.level!==n.QNLogLevel.VERBOSE&&this.level!==n.QNLogLevel.INFO)return;const t=this.getLogTimeString()+" %cDEBUG-QNRTC";console.info(t,"color: #A28148; font-weight: bold;",...e)}warning(...e){if(this.level===n.QNLogLevel.NONE)return;const t=this.getLogTimeString()+" %cWARNING-QNRTC";console.info(t,"color: #E44F44; font-weight: bold;",...e)}checkValidate(e){return Object.keys(n.QNLogLevel).includes(e)?e:n.QNLogLevel.VERBOSE}}(n.QNLogLevel.VERBOSE)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.noop=t.toUTF8Array=t.request=t.rpcid=t.diff=t.timeout=t.getRoomAccessFromToken=void 0;const n=r(11);t.getRoomAccessFromToken=function(e){const t=e.split(":")[2],r=(0,n.decode)(t);return JSON.parse(r)},t.timeout=function(e=1e3){return new Promise(t=>{setTimeout(()=>{t()},e)})};t.diff=(e=[],t=[],r)=>{const n={add:[],remove:[]};if(0===e.length)return n.add=t,n;if(0===t.length)return n.remove=e,n;const s=e.map(r),o=t.map(r);return s.forEach((t,r)=>{-1===o.indexOf(t)&&n.remove.push(e[r])}),o.forEach((e,r)=>{-1===s.indexOf(e)&&n.add.push(t[r])}),n};t.rpcid=()=>Math.random().toString(36).substring(7),t.request=function(e,t){return new Promise((r,n)=>{wx.request(Object.assign(Object.assign({url:e},t),{success:e=>{const t=e.statusCode;t>=200&&t<300?r(e.data):n(e)},fail:n}))})},t.toUTF8Array=function(e){const t=[];for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);n<128?t.push(n):n<2048?t.push(192|n>>6,128|63&n):n<55296||n>=57344?t.push(224|n>>12,128|n>>6&63,128|63&n):(r++,n=65536+((1023&n)<<10|1023&e.charCodeAt(r)),t.push(240|n>>18,128|n>>12&63,128|n>>6&63,128|63&n))}return new Uint8Array(t)};t.noop=()=>{}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SIGNALING_URL=t.QNRTC_EVENTS_STORATE_KEY=t.OS_PLATFORM=t.QOS_VERSION=t.VERSION=void 0,t.VERSION="4.0.8",t.QOS_VERSION="2.0",t.OS_PLATFORM="wechat miniprogram",t.QNRTC_EVENTS_STORATE_KEY="qnrtcqosevents",t.SIGNALING_URL="wss://rtmpgate.cloudvdn.com/"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNTrack=void 0;const n=r(0),s=r(13);class o extends s.QNTrackEvent{constructor(e){super(),this._trackID=e.trackID,this._userID=e.userID,this._tag=e.tag,this._kind=e.kind,this._muted=e.muted}get trackID(){return this._trackID}get userID(){return this._userID}get tag(){return this._tag}isMuted(){return this._muted}isAudio(){return this._kind===n.QNMediaType.audio}isVideo(){return this._kind===n.QNMediaType.video}}t.QNTrack=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNRemoteUser=void 0;t.QNRemoteUser=class{constructor(e){this._userData=e.userData,this._userID=e.userID,this._audioTracks=e.audioTracks,this._videoTracks=e.videoTracks}get userData(){return this._userData}get userID(){return this._userID}getVideoTracks(){return this._videoTracks}getAudioTracks(){return this._audioTracks}}},function(e,t){e.exports=require("events")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNRemoteTrack=void 0;const n=r(6);class s extends n.QNTrack{}t.QNRemoteTrack=s},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,s)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return s(t,e),t},i=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(s,o){function i(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}c((n=n.apply(e,t||[])).next())}))},a=this&&this.__rest||function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(r[n[s]]=e[n[s]])}return r};Object.defineProperty(t,"__esModule",{value:!0}),t.QNRTCClient=void 0;const c=r(0),u=r(7),d=o(r(1)),l=r(4),h=o(r(12)),f=r(5),g=r(3),E=r(9),_=r(22),p=o(r(2)),m=r(23);class v extends m.QNCore{join(e,t=""){return i(this,void 0,void 0,(function*(){try{const r=(0,l.getRoomAccessFromToken)(e);this.userId=r.userId,this.roomName=r.roomName,this.appId=r.appId,this.token=e,this.userData=t,d.default.addEvent(d.QosEventType.JoinRoom,{room_token:e,user_data:t})}catch(e){return Promise.reject(p.ERROR_FATAL("can not parse roomToken, "+e))}const r=v.SIGNALINGURL;r||p.ERROR_FATAL("signaling url is null or empty"),this.signaling=new h.default(r,this.appId,e,this.userId,this.roomName,t),this.handleSignaling();try{yield this.signaling.init();const e=yield this.signaling.sendAuth();return g.logger.log("Init",e),this.rtmptoken=e.rtmptoken,this.rtmphost=e.rtmphost,this.tracks=(e.tracks||[]).map(e=>new E.QNRemoteTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind})),this.users=(e.players||[]).filter(e=>e.playerid!==this.userId).map(e=>{const t=new u.QNRemoteUser({userData:e.playerdata,userID:e.playerid,audioTracks:this.tracks.filter(t=>t.userID==e.playerid&&t.isAudio()),videoTracks:this.tracks.filter(t=>t.userID==e.playerid&&t.isVideo())});return this.emit(m.QNCore.USER_JOINED,t.userID,t.userData),(t.getAudioTracks().length>0||t.getVideoTracks().length>0)&&this.emit(m.QNCore.USER_PUBLISHED,t.userID,[...t.getAudioTracks(),...t.getVideoTracks()]),t}),Promise.resolve()}catch(e){if(e instanceof p.QNRTCError)return this.signaling.changeState({state:c.QNConnectionState.DISCONNECTED,info:{reason:c.QNConnectionDisconnectedReason.ERROR,errorCode:e.code,errorMessage:e.message}}),Promise.reject(e)}}))}leave(){return i(this,void 0,void 0,(function*(){return this._leave()}))}publish(e){return i(this,void 0,void 0,(function*(){e(c.QNPublishStatus.READY,{url:`rtmp://${this.rtmphost}?rtmptoken=${this.rtmptoken}&playerid=${this.userId}`}),this.publishCallback=e}))}subscribe(e){return i(this,void 0,void 0,(function*(){const t=e.videoTrack,r=e.audioTrack;g.logger.log("SubscribeTracks:",e);let n="";if(t&&r)n=`rtmp://${this.rtmphost}?rtmptoken=${this.rtmptoken}&trackid=${t.trackID}&trackid=${r.trackID}&playerid=${t.userID}`;else if(r)n=`rtmp://${this.rtmphost}?rtmptoken=${this.rtmptoken}&trackid=${r.trackID}&playerid=${r.userID}`;else{if(!t)return Promise.reject(p.ERROR_FATAL("no subscribe tracks"));n=`rtmp://${this.rtmphost}?rtmptoken=${this.rtmptoken}&trackid=${t.trackID}&playerid=${t.userID}`}g.logger.log("SubscribeRtmp:",n);let s=[];return t&&s.push(t),r&&s.push(r),d.default.addEvent(d.QosEventType.SubscribeTracks,{tracks:s.map(e=>({track_id:e.trackID,kind:e._kind,tag:e.tag,muted:e.isMuted()}))}),n}))}sendMessage(e,t,r=[]){return i(this,void 0,void 0,(function*(){const n={msgid:e,target:r.map(e=>e.userID),type:"normal",text:t};return this.signaling.request(h.SignalingType.sendMessage,n).then(()=>Promise.resolve())}))}startDirectLiveStreaming(e){var t,r;return i(this,void 0,void 0,(function*(){const n=!!e.audioTrack&&!e.videoTrack,s=[null===(t=e.audioTrack)||void 0===t?void 0:t.trackID,null===(r=e.videoTrack)||void 0===r?void 0:r.trackID].filter(Boolean).map(e=>({trackid:e}));if(0==s.length)throw p.ERROR_INVALID_PARAMETER("No track provided. Please check the parameter.");const o={id:e.streamID,publishUrl:e.url,audioOnly:n,tracks:s,seiTemplate:{}};e&&e.userConfigExtraInfo&&(o.seiTemplate={value:e.userConfigExtraInfo});const i=Date.now();return this.signaling.request(h.SignalingType.createForwardJob,o).then(e=>(d.default.addEvent(d.QosEventType.CreateForwardJob,{signal_take_time:Date.now()-i,result_code:e.code}),e)).then(()=>Promise.resolve())}))}stopDirectLiveStreaming(e){return i(this,void 0,void 0,(function*(){return d.default.addEvent(d.QosEventType.StopForwardJob,{id:e}),this.signaling.request(h.SignalingType.stopForward,{id:e,delayMillisecond:0}).then(()=>Promise.resolve())}))}startTranscodingLiveStreaming(e){return i(this,void 0,void 0,(function*(){const t=Date.now(),r=Object.assign(_.TranscodingLiveStreamingPreset,e),{streamID:n,renderMode:s}=r,o=a(r,["streamID","renderMode"]);return this.signaling.request(h.SignalingType.createMergeJob,Object.assign(Object.assign({},o),{id:n,rpcid:(0,l.rpcid)(),stretchMode:s})).then(r=>(d.default.addEvent(d.QosEventType.CreateMergeJob,{signal_take_time:Date.now()-t,id:e.streamID,result_code:r.code}),Promise.resolve()))}))}stopTranscodingLiveStreaming(e){return i(this,void 0,void 0,(function*(){return d.default.addEvent(d.QosEventType.StopMerge,{id:e}),this.signaling.request(h.SignalingType.stopMerge,{id:e}).then(()=>Promise.resolve())}))}setTranscodingLiveStreamingTracks(e,t){return i(this,void 0,void 0,(function*(){const r={id:e,add:(t||[]).map(e=>Object.assign(Object.assign({trackid:e.trackID},_.MergeTracksPreset),{x:e.x,y:e.y,w:e.width,h:e.height,z:e.zOrder,stretchMode:e.renderMode}))};return d.default.addEvent(d.QosEventType.UpdateMergeTracks,r),this.signaling.request(h.SignalingType.updateMergeTracks,r).then(()=>Promise.resolve())}))}removeTranscodingLiveStreamingTracks(e,t){return i(this,void 0,void 0,(function*(){const r={id:e,remove:(t||[]).map(e=>Object.assign(Object.assign({trackid:e.trackID},_.MergeTracksPreset),{x:e.x,y:e.y,w:e.width,h:e.height,z:e.zOrder,stretchMode:e.renderMode}))};return d.default.addEvent(d.QosEventType.UpdateMergeTracks,r),this.signaling.request(h.SignalingType.updateMergeTracks,r).then(()=>Promise.resolve())}))}static set SIGNALINGURL(e){v._SIGNALING_URL=e}static get SIGNALINGURL(){return v._SIGNALING_URL}}t.QNRTCClient=v,v._SIGNALING_URL=f.SIGNALING_URL},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Base64=t.extendBuiltins=t.extendUint8Array=t.extendString=t.toUint8Array=t.fromUint8Array=t.isValid=t.decode=t.btou=t.encodeURL=t.encodeURI=t.encode=t.utob=t.toBase64=t.fromBase64=t.btoaPolyfill=t.btoa=t.atobPolyfill=t.atob=t.VERSION=t.version=void 0;t.version="3.7.2";t.VERSION="3.7.2";const n="function"==typeof atob,s="function"==typeof btoa,o="function"==typeof Buffer,i="function"==typeof TextDecoder?new TextDecoder:void 0,a="function"==typeof TextEncoder?new TextEncoder:void 0,c=Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="),u=(e=>{let t={};return e.forEach((e,r)=>t[e]=r),t})(c),d=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,l=String.fromCharCode.bind(String),h="function"==typeof Uint8Array.from?Uint8Array.from.bind(Uint8Array):(e,t=(e=>e))=>new Uint8Array(Array.prototype.slice.call(e,0).map(t)),f=e=>e.replace(/=/g,"").replace(/[+\/]/g,e=>"+"==e?"-":"_"),g=e=>e.replace(/[^A-Za-z0-9\+\/]/g,""),E=e=>{let t,r,n,s,o="";const i=e.length%3;for(let i=0;i<e.length;){if((r=e.charCodeAt(i++))>255||(n=e.charCodeAt(i++))>255||(s=e.charCodeAt(i++))>255)throw new TypeError("invalid character found");t=r<<16|n<<8|s,o+=c[t>>18&63]+c[t>>12&63]+c[t>>6&63]+c[63&t]}return i?o.slice(0,i-3)+"===".substring(i):o};t.btoaPolyfill=E;const _=s?e=>btoa(e):o?e=>Buffer.from(e,"binary").toString("base64"):E;t.btoa=_;const p=o?e=>Buffer.from(e).toString("base64"):e=>{let t=[];for(let r=0,n=e.length;r<n;r+=4096)t.push(l.apply(null,e.subarray(r,r+4096)));return _(t.join(""))},m=(e,t=!1)=>t?f(p(e)):p(e);t.fromUint8Array=m;const v=e=>{if(e.length<2)return(t=e.charCodeAt(0))<128?e:t<2048?l(192|t>>>6)+l(128|63&t):l(224|t>>>12&15)+l(128|t>>>6&63)+l(128|63&t);var t=65536+1024*(e.charCodeAt(0)-55296)+(e.charCodeAt(1)-56320);return l(240|t>>>18&7)+l(128|t>>>12&63)+l(128|t>>>6&63)+l(128|63&t)},T=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,R=e=>e.replace(T,v);t.utob=R;const N=o?e=>Buffer.from(e,"utf8").toString("base64"):a?e=>p(a.encode(e)):e=>_(R(e)),k=(e,t=!1)=>t?f(N(e)):N(e);t.toBase64=k,t.encode=k;const O=e=>k(e,!0);t.encodeURI=O,t.encodeURL=O;const b=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,S=e=>{switch(e.length){case 4:var t=((7&e.charCodeAt(0))<<18|(63&e.charCodeAt(1))<<12|(63&e.charCodeAt(2))<<6|63&e.charCodeAt(3))-65536;return l(55296+(t>>>10))+l(56320+(1023&t));case 3:return l((15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2));default:return l((31&e.charCodeAt(0))<<6|63&e.charCodeAt(1))}},C=e=>e.replace(b,S);t.btou=C;const y=e=>{if(e=e.replace(/\s+/g,""),!d.test(e))throw new TypeError("malformed base64.");e+="==".slice(2-(3&e.length));let t,r,n,s="";for(let o=0;o<e.length;)t=u[e.charAt(o++)]<<18|u[e.charAt(o++)]<<12|(r=u[e.charAt(o++)])<<6|(n=u[e.charAt(o++)]),s+=64===r?l(t>>16&255):64===n?l(t>>16&255,t>>8&255):l(t>>16&255,t>>8&255,255&t);return s};t.atobPolyfill=y;const D=n?e=>atob(g(e)):o?e=>Buffer.from(e,"base64").toString("binary"):y;t.atob=D;const I=o?e=>h(Buffer.from(e,"base64")):e=>h(D(e),e=>e.charCodeAt(0)),A=e=>I(w(e));t.toUint8Array=A;const P=o?e=>Buffer.from(e,"base64").toString("utf8"):i?e=>i.decode(I(e)):e=>C(D(e)),w=e=>g(e.replace(/[-_]/g,e=>"-"==e?"+":"/")),Q=e=>P(w(e));t.fromBase64=Q,t.decode=Q;const M=e=>{if("string"!=typeof e)return!1;const t=e.replace(/\s+/g,"").replace(/={0,2}$/,"");return!/[^\s0-9a-zA-Z\+/]/.test(t)||!/[^\s0-9a-zA-Z\-_]/.test(t)};t.isValid=M;const L=e=>({value:e,enumerable:!1,writable:!0,configurable:!0}),j=function(){const e=(e,t)=>Object.defineProperty(String.prototype,e,L(t));e("fromBase64",(function(){return Q(this)})),e("toBase64",(function(e){return k(this,e)})),e("toBase64URI",(function(){return k(this,!0)})),e("toBase64URL",(function(){return k(this,!0)})),e("toUint8Array",(function(){return A(this)}))};t.extendString=j;const U=function(){const e=(e,t)=>Object.defineProperty(Uint8Array.prototype,e,L(t));e("toBase64",(function(e){return m(this,e)})),e("toBase64URI",(function(){return m(this,!0)})),e("toBase64URL",(function(){return m(this,!0)}))};t.extendUint8Array=U;const x=()=>{j(),U()};t.extendBuiltins=x;const V={version:"3.7.2",VERSION:"3.7.2",atob:D,atobPolyfill:y,btoa:_,btoaPolyfill:E,fromBase64:Q,toBase64:k,encode:k,encodeURI:O,encodeURL:O,utob:R,btou:C,decode:Q,isValid:M,fromUint8Array:m,toUint8Array:A,extendString:j,extendUint8Array:U,extendBuiltins:x};t.Base64=V},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,s)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return s(t,e),t},i=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(s,o){function i(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}c((n=n.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SignalingType=void 0;const c=r(8),u=r(5),d=r(4),l=r(3),h=o(r(1)),f=a(r(21)),g=r(0),E=o(r(2)),_=r(2);var p;!function(e){e.stopMerge="stop-merge",e.auth="auth",e.sendMessage="send-message",e.createMergeJob="create-merge-job",e.updateMergeTracks="update-merge-tracks",e.createForwardJob="create-forward-job",e.stopForward="stop-forward",e.muteTracks="mute-tracks"}(p=t.SignalingType||(t.SignalingType={}));class m extends c.EventEmitter{constructor(e,t,r,n,s,o){super(),this.url=e,this.appId=t,this.token=r,this.userId=n,this.roomName=s,this.userData=o,this.reconnectTimeout=3e3,this.reconnectTimeoutID=void 0,this.startAuthTime=0,this.fireTimes=0,h.default.setUserBase(n,s,t)}init(e=!1){return new Promise((t,r)=>{this.changeState({state:e?g.QNConnectionState.RECONNECTING:g.QNConnectionState.CONNECTING}),this.startAuthTime=Date.now(),this.ws&&this.ws.silentClose();const n=Date.now(),s=new f.default(this.url);s.on("open",()=>{l.logger.log("OnSocketOpen",{socket_node_info:this.url,socket_connect_time:Date.now()-n,socket_connect_result_code:0,socket_connect_reason:g.QNConnectionState.CONNECTING.toLowerCase()}),h.default.addEvent(h.QosEventType.WebsocketConnect,{event_grade:h.EVENT_GRADE.NORMAL,event_category:h.EVENT_CATEGORY.CORE,socket_node_info:this.url,socket_connect_time:Date.now()-n,socket_connect_result_code:0,socket_connect_reason:g.QNConnectionState.CONNECTING.toLowerCase()}),t()}),s.on("close",e=>{h.default.addEvent(h.QosEventType.WebsocketConnect,{event_grade:h.EVENT_GRADE.SERVERE,event_category:h.EVENT_CATEGORY.CORE,socket_node_info:this.url,socket_connect_time:Date.now()-n,socket_connect_result_code:e.code,socket_connect_error_message:e.reason,socket_connect_reason:g.QNConnectionState.RECONNECTING.toLowerCase()}),r(E.ERROR_AUTH_FAILED(e.reason))}),s.on("errors",e=>{r(E.ERROR_AUTH_FAILED(e.errMsg))}),s.on("message",this.onMessage.bind(this)),this.ws=s})}onClose(e){switch(l.logger.warning("OnSocketClose: ",e.code,e.reason),h.default.addEvent(h.QosEventType.AbnormalDisconnect,{event_grade:h.EVENT_GRADE.SERVERE,event_category:h.EVENT_CATEGORY.CORE,event_reason_code:e.code,event_description:e.reason,socket_node_info:this.url}),Number(e.code)){case 1e3:{const t=E.ERROR_FATAL(e.reason);this.changeState({state:g.QNConnectionState.DISCONNECTED,info:{errorCode:t.code,errorMessage:t.message,reason:g.QNConnectionDisconnectedReason.ERROR}});break}case 1001:case 1005:this.reconnect();break;case 1006:delete this.rtmptoken,this.changeState({state:g.QNConnectionState.DISCONNECTED,info:{errorCode:1006,errorMessage:"网络异常中断",reason:g.QNConnectionDisconnectedReason.ERROR}});break;case 1011:this.reconnect();break;case 1012:this.reconnect(5e3);break;case 1013:this.reconnect();break;case 1014:this.reconnect(5e3)}}onMessage(e){const t=e.data.indexOf("=");if(t>0){const r=e.data.substring(0,t),n=JSON.parse(e.data.substring(t+1));l.logger.log("WsReceive",r,n),this.receiveWsMsg(r,n)}else l.logger.error("WsReceive",e)}receiveWsMsg(e,t){"on-rtmp-conn-closed"===e?h.default.addEvent(h.QosEventType.AbnormalDisconnect,{event_grade:h.EVENT_GRADE.SERVERE,event_category:h.EVENT_CATEGORY.CORE,event_reason_code:-2,event_description:t.error,socket_node_info:this.url}):"ping"===e?this.handlePing():t.rpcid?this.emit("#message#"+t.rpcid,t):this.emit("#message",e,t)}send(e,t={}){if(!this.ws)return Promise.reject();const r=`${e}=${JSON.stringify(t)}`;return l.logger.log("WsSend",e,t),this.ws.send(r)}request(e,t={}){return new Promise((r,n)=>{t.rpcid||(t.rpcid=(0,d.rpcid)(),h.default.setRpcId(t.rpcid)),this.send(e,t).catch(n),this.once("#message#"+t.rpcid,e=>{if(0===e.code)r(e);else switch(e.code){case 10053:n(E.ERROR_INVALID_PARAMETER(e.error));break;case 10001:case 10002:case 10022:n(E.JOIN_ROOM_ERROR(e.code,e.error));break;default:n(E.SERVER_ERROR(e.code,e.error))}})})}close(){this.reconnectTimeoutID&&(clearTimeout(this.reconnectTimeoutID),this.reconnectTimeoutID=void 0),this.ws&&this.ws.silentClose()}handlePing(){this.state!==g.QNConnectionState.CONNECTED&&this.state!==g.QNConnectionState.RECONNECTED||this.send("pong",{}),this.reconnectTimeoutID&&(clearTimeout(this.reconnectTimeoutID),this.reconnectTimeoutID=void 0),this.reconnectTimeoutID=setTimeout(()=>{l.logger.warning("Signaling","websocket heartbeat timeout"),h.default.addEvent(h.QosEventType.AbnormalDisconnect,{event_grade:h.EVENT_GRADE.SERVERE,event_category:h.EVENT_CATEGORY.CORE,event_reason_code:-1,event_description:"websocket heartbeat timeout",socket_node_info:this.url}),this.reconnect()},9e3)}changeState(e){const t={[g.QNConnectionState.CONNECTING]:1,[g.QNConnectionState.CONNECTED]:2,[g.QNConnectionState.RECONNECTING]:3,[g.QNConnectionState.RECONNECTED]:4,[g.QNConnectionState.DISCONNECTED]:5};h.default.addEvent(h.QosEventType.RoomStateChanged,{room_state:t[e.state],event_grade:e.state===g.QNConnectionState.RECONNECTED||e.state===g.QNConnectionState.RECONNECTING?h.EVENT_GRADE.SERVERE:h.EVENT_GRADE.NORMAL,event_category:h.EVENT_CATEGORY.CORE,state_change_code:e.info?e.info.errorCode:0,state_change_reason:e.info?e.info.reason:""}),l.logger.log("RoomStateChanged",e.state.toLowerCase()),this.emit("connection-state-changed",e.state,e.auth,e.info),this.state=e.state}reconnect(e=1e3){return this.reconnectTimeoutID&&(clearTimeout(this.reconnectTimeoutID),this.reconnectTimeoutID=void 0),this.state===g.QNConnectionState.DISCONNECTED?(this.ws&&this.ws.silentClose(),Promise.resolve()):(this.reconnectTask||(this.reconnectTimeoutID=setTimeout(()=>{const e=E.ERROR_RECONNECT_FAILED();this.changeState({state:g.QNConnectionState.DISCONNECTED,info:{errorCode:e.code,errorMessage:e.message,reason:g.QNConnectionDisconnectedReason.ERROR}}),this.reconnectTimeoutID=void 0},this.reconnectTimeout),l.logger.log("Signaling","websocket reconnecting"),this.reconnectTask=(0,d.timeout)(e).then(this.init.bind(this,!0)).then(this.sendAuth.bind(this,!0)).then(e=>(clearTimeout(this.reconnectTimeoutID),this.reconnectTimeoutID=void 0,this.reconnectTask=void 0,l.logger.log("Signaling","websocket reconnected"),e)).catch(e=>{if(this.reconnectTask=void 0,e instanceof _.QNRTCError){if(10001!==e.code)return this.reconnect();this.changeState({state:g.QNConnectionState.DISCONNECTED,info:{errorCode:e.code,errorMessage:e.message,reason:g.QNConnectionDisconnectedReason.ERROR}}),delete this.rtmptoken}})),this.reconnectTask)}sendAuth(e=!1){var t,r,n;return i(this,void 0,void 0,(function*(){let s,o;!e&&(this.fireTimes=0),s=this.rtmptoken?{rtmptoken:this.rtmptoken}:{app:this.appId,agent:u.OS_PLATFORM,roomtoken:this.token,sdkversion:u.VERSION,room:this.roomName,user:this.userId,playerdata:this.userData},h.default.setSessionId(this.rtmptoken||this.token);try{return o=yield this.request(p.auth,s),this.changeState({state:e?g.QNConnectionState.RECONNECTED:g.QNConnectionState.CONNECTED,auth:o}),this.handlePing(),this.fireTimes+=1,null===(t=this.ws)||void 0===t||t.removeAllListeners("close"),null===(r=this.ws)||void 0===r||r.removeAllListeners("errors"),null===(n=this.ws)||void 0===n||n.on("close",this.onClose.bind(this)),this.rtmptoken=o.rtmptoken,h.default.addEvent(h.QosEventType.SignalAuth,{event_grade:h.EVENT_GRADE.NORMAL,event_category:h.EVENT_CATEGORY.CORE,auth_start_time:this.startAuthTime,auth_agent:u.OS_PLATFORM,auth_error_code:o.code,auth_error_message:o.error,auth_take_time:Date.now()-this.startAuthTime,room_token:this.token,rtmphost:o.rtmphost,rtmptoken:o.rtmptoken,fire_times:this.fireTimes,auth_reason:e?"reconnect":"connect"}),o}catch(t){return this.fireTimes+=1,t instanceof _.QNRTCError&&h.default.addEvent(h.QosEventType.SignalAuth,{event_grade:h.EVENT_GRADE.SERVERE,event_category:h.EVENT_CATEGORY.CORE,auth_start_time:this.startAuthTime,auth_agent:u.OS_PLATFORM,auth_error_code:t.code,auth_error_message:t.message,auth_take_time:Date.now()-this.startAuthTime,room_token:this.token,fire_times:this.fireTimes,auth_reason:e?"reconnect":"connect"}),Promise.reject(t)}}))}}t.default=m},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNTrackEvent=t.QNRTCClinetEvent=void 0;const n=r(8);class s extends n.EventEmitter{addListener(){return this}}t.QNRTCClinetEvent=s,s.USER_JOINED="user-joined",s.USER_LEFT="user-left",s.USER_PUBLISHED="user-published",s.USER_UNPUBLISHED="user-unpublished",s.CONNECTION_STATE_CHANGED="connection-state-changed",s.MESSAGE_RECEIVED="message-received";class o extends n.EventEmitter{addListener(){return this}}t.QNTrackEvent=o,o.MUTE_STATE_CHANGED="mute-state-changed"},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,s)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return s(t,e),t},i=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(s,o){function i(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.QNLocalTrack=void 0;const a=r(6),c=o(r(1)),u=r(2);class d extends a.QNTrack{setMuted(e){return i(this,void 0,void 0,(function*(){return new Promise((t,r)=>{this.emit("mute",{tracks:[{trackid:this.trackID,muted:e}]},t,r)}).then(()=>{this._muted=e,c.default.addEvent(c.QosEventType.MuteTracks,{result_code:0,signal_take_time:0,tracks:[{track_id:this.trackID,muted:e,kind:this._kind}]})}).catch(t=>{if(t instanceof u.QNRTCError)return c.default.addEvent(c.QosEventType.MuteTracks,{result_code:t.code,signal_take_time:0,tracks:[{track_id:this.trackID,muted:e,kind:this._kind}]}),Promise.reject(t)})}))}}t.QNLocalTrack=d},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,s)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),s=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),t.QNRTCClient=t.default=void 0;var o=r(16);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return o.QNRTC}});var i=r(10);Object.defineProperty(t,"QNRTCClient",{enumerable:!0,get:function(){return i.QNRTCClient}}),s(r(14),t),s(r(9),t),s(r(7),t),s(r(6),t),s(r(0),t)},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,s)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.QNRTC=void 0;const i=r(10),a=r(5),c=r(3),u=o(r(1));t.QNRTC=class{static createClient(){return u.default.init(),u.default.addEvent(u.QosEventType.Init,{id:"track_"+Date.now()}),new i.QNRTCClient}static get VERSION(){return a.VERSION}static setLogLevel(e){c.logger.setLevel(e)}static updatePlayerStateChange(e){e&&e.detail?u.default.addEvent(u.QosEventType.WechatPlayerStatus,e.detail):c.logger.error("UpdatePlayerStateChange","params is wrong")}static updatePlayerNetStatus(e){e&&e.detail&&e.detail.info?u.default.addEvent(u.QosEventType.WechatPlayerStatistics,e.detail.info):c.logger.error("UpdatePlayerNetStatus","param is wrong")}static updatePusherStateChange(e){e&&e.detail?u.default.addEvent(u.QosEventType.WechatPusherStatus,e.detail):c.logger.error("UpdatePusherStateChange","params is wrong")}static updatePusherNetStatus(e){e&&e.detail&&e.detail.info?u.default.addEvent(u.QosEventType.WechatPusherStatistics,e.detail.info):c.logger.error("UpdatePusherNetStatus","param is wrong")}static set signalingUrl(e){i.QNRTCClient.SIGNALINGURL=e}static get signalingUrl(){return i.QNRTCClient.SIGNALINGURL}}},function(e,t){e.exports=require("fingerprintjs2")},function(e,t){e.exports=require("blueimp-md5")},function(e,t){e.exports=require("gzip-js")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.groupBy=t.find=void 0;t.find=(e,t)=>e&&0!==e.length?e.find(t):null;t.groupBy=(e,t)=>{if(!e||0===e.length)return{};const r={};return e.forEach(e=>{const n=t(e);r[n]?r[n].push(e):r[n]=[e]}),r}},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,s)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const i=r(8),a=r(3),c=o(r(2));class u extends i.EventEmitter{constructor(e){super();const t=this;this.socketTask=wx.connectSocket({url:e,success:e=>{a.logger.log("SocketConnect",e)},fail(e){a.logger.error("SocketConnect",e),setTimeout(()=>{t.emit("errors",e)},0)}}),this.socketTask&&(this.socketTask.onClose(this.emit.bind(this,"close")),this.socketTask.onError(this.emit.bind(this,"errors")),this.socketTask.onMessage(this.emit.bind(this,"message")),this.socketTask.onOpen(this.emit.bind(this,"open")))}send(e){return new Promise((t,r)=>{this.socketTask.send({data:e,success:t,fail:e=>{r(c.ERROR_FATAL(e.errMsg))}})})}close(){this.socketTask.close({fail:e=>a.logger.error("SocketClose",e)})}silentClose(){this.removeAllListeners(),this.socketTask.close({fail:e=>a.logger.error("SocketClose",e)})}}t.default=u},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MergeTracksPreset=t.TranscodingLiveStreamingPreset=void 0;const n=r(0);t.TranscodingLiveStreamingPreset={publishUrl:"",audioOnly:"",height:"",width:"",fps:"",kbps:"",minRate:"",maxRate:"",renderMode:"aspectFill",holdLastFrame:!1,watermarks:[],background:{}},t.MergeTracksPreset={x:0,y:0,w:0,h:0,z:0,stretchMode:n.QNRenderMode.ASPECT_FILL}},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,s)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return s(t,e),t},i=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(s,o){function i(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.QNCore=void 0;const a=r(0),c=r(7),u=r(13),d=o(r(1)),l=r(12),h=r(9),f=r(4),g=r(14),E=r(6),_=o(r(2));class p extends u.QNRTCClinetEvent{constructor(){super(...arguments),this.localTracks=[],this.userId="",this.roomName="",this.appId="",this.token="",this.rtmptoken="",this.rtmphost="",this.userData="",this.tracks=[],this.users=[]}handleSignaling(){this.signaling&&(this.signaling.on("#message",this.onMessage.bind(this)),this.signaling.on("connection-state-changed",this.onConnectionStateChanged.bind(this)))}onMessage(e,t){var r,n,s;switch(e){case"on-player-in":this.onPlayerIn(new c.QNRemoteUser({userData:t.playerdata,userID:t.playerid,audioTracks:[],videoTracks:[]}));break;case"on-player-out":this.onPlayerOut(new c.QNRemoteUser({userData:t.playerdata,userID:t.playerid,audioTracks:[],videoTracks:[]}));break;case"on-add-tracks":this.onAddTracks(t);break;case"on-remove-tracks":this.onRemoveTracks(t);break;case"on-add-local-tracks":this.onAddLocalTracks(t.tracks);break;case"disconnect":10006===t.code?(d.default.addEvent(d.QosEventType.KickoutUser,{user_id:this.userId,result_code:t.code,signal_take_time:0}),null===(r=this.signaling)||void 0===r||r.changeState({state:a.QNConnectionState.DISCONNECTED,info:{reason:a.QNConnectionDisconnectedReason.KICKED_OUT,errorCode:t.code}})):0===t.code?null===(n=this.signaling)||void 0===n||n.changeState({state:a.QNConnectionState.DISCONNECTED,info:{reason:a.QNConnectionDisconnectedReason.LEAVE,errorCode:t.code}}):null===(s=this.signaling)||void 0===s||s.changeState({state:a.QNConnectionState.DISCONNECTED,info:{reason:a.QNConnectionDisconnectedReason.ERROR,errorCode:t.code,errorMessage:t.error}});break;case"on-messages":this.onMessageReceived(t);break;case"mute-tracks":this.onMuteTracks(t)}}onConnectionStateChanged(e,t,r){if(e===a.QNConnectionState.RECONNECTED){this.rtmptoken=t.rtmptoken,this.rtmphost=t.rtmphost;const r=(t.players||[]).filter(e=>e.playerid!==this.userId),n=(t.tracks||[]).filter(e=>e.playerid!==this.userId);Promise.resolve().then(()=>{const e=(0,f.diff)(this.tracks,n.map(e=>new h.QNRemoteTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind})),e=>e.trackID);e.remove.length>0&&this.onPlayerUnPublish(e.remove),e.add.length>0&&this.onPlayerPublish(e.add);const t=(0,f.diff)(this.users,r.map(e=>new c.QNRemoteUser({userData:e.playerdata,userID:e.playerid,audioTracks:this.tracks.filter(t=>t.userID==e.playerid&&t.isAudio()),videoTracks:this.tracks.filter(t=>t.userID==e.playerid&&t.isVideo())})),e=>e.userID);t.remove.forEach(this.onPlayerOut,this),t.add.forEach(this.onPlayerIn,this)}),this.emit(p.CONNECTION_STATE_CHANGED,e)}else e===a.QNConnectionState.DISCONNECTED?(this.emit(p.CONNECTION_STATE_CHANGED,e,r),this.releaseRoom({code:null==r?void 0:r.errorCode})):this.emit(p.CONNECTION_STATE_CHANGED,e)}onAddLocalTracks(e){this.localTracks=e.map(e=>new g.QNLocalTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind})),this.localTracks.forEach(e=>{e.on("mute",(e,t,r)=>i(this,void 0,void 0,(function*(){try{const r=yield this.signaling.request(l.SignalingType.muteTracks,e);t(r)}catch(e){r(e)}})))}),d.default.addEvent(d.QosEventType.PublishTracks,{signal_take_time:0,result_code:0,tracks:(this.localTracks||[]).map(e=>({track_id:e.trackID,kind:e._kind,tag:e.tag,muted:e.isMuted()}))}),this.publishCallback(a.QNPublishStatus.COMPLETED,{tracks:this.localTracks})}onRemoveTracks(e){const t=e.tracks.map(e=>new h.QNRemoteTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind}));t.forEach(e=>{this.users.forEach(t=>{if(t.userID===e.userID)if(e.isAudio()){const r=t._audioTracks.findIndex(t=>t.trackID===e.trackID);r>=0&&t._audioTracks.splice(r,1)}else if(e.isVideo()){const r=t._audioTracks.findIndex(t=>t.trackID===e.trackID);r>=0&&t._audioTracks.splice(r,1)}})}),this.onPlayerUnPublish(t)}onAddTracks(e){const t=e.tracks.map(e=>new h.QNRemoteTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind}));t.forEach(e=>{this.users.forEach(t=>{t.userID===e.userID&&(e.isAudio()?t._audioTracks.push(e):e.isVideo()&&t._videoTracks.push(e))})}),this.onPlayerPublish(t)}onMessageReceived(e){for(let t of e.messages)this.emit(p.MESSAGE_RECEIVED,{ID:t.msgid,userID:t.playerid,content:t.text,timestamp:t.msgts})}onMuteTracks(e){for(let t of e.tracks){const e=this.tracks.findIndex(e=>e.trackID===t.trackid);e>=0&&(this.tracks[e]._muted=t.muted,this.tracks[e].emit(E.QNTrack.MUTE_STATE_CHANGED))}}onPlayerOut(e){this.users=this.users.filter(t=>t.userID!==e.userID),this.emit(p.USER_LEFT,e.userID)}onPlayerIn(e){const t=this.users.findIndex(t=>t.userID===e.userID);t>=0?this.users[t]=e:this.users.push(e),this.emit(p.USER_JOINED,e.userID,e.userData)}onPlayerPublish(e){let t={};e.forEach(e=>{const r=this.tracks.findIndex(t=>t.trackID===e.trackID);r>=0?this.tracks[r]=e:this.tracks.push(e),t[e.userID]?t[e.userID].push(e):t[e.userID]=[e]});for(let e in t)this.emit(p.USER_PUBLISHED,e,t[e])}onPlayerUnPublish(e){let t=[];this.tracks=this.tracks.filter(r=>!e.some(e=>e.trackID===r.trackID)||(t.push(r),!1));let r={};t.forEach(e=>{r[e.userID]?r[e.userID].push(e):r[e.userID]=[e]});for(let e in r)this.emit(p.USER_UNPUBLISHED,e,r[e])}releaseRoom(e){d.default.addEvent(d.QosEventType.LeaveRoom,{leave_reason_code:e.code}),this.removeAllListeners(),this.localTracks=[],this.tracks=[],this.users=[],d.default.addEvent(d.QosEventType.UnInit,{id:"track_"+Date.now()},!0),this.signaling&&(this.signaling.close(),this.signaling=void 0)}_leave(){return i(this,void 0,void 0,(function*(){return this.signaling?this.signaling.send("disconnect").then(()=>(this.releaseRoom({code:0}),Promise.resolve())).catch(e=>Promise.reject(e)):Promise.reject(_.ERROR_INVALID_STATE())}))}}t.QNCore=p}]);
//# sourceMappingURL=index.js.map